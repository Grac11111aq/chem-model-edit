# Feature Specification: 計算化学向け構造編集Webアプリ

**Feature Branch**: `[001-chem-model-webapp]`  
**Created**: 2026-01-05  
**Status**: Draft  
**Input**: User description: "計算化学の学生/研究者が構造の可視化・編集を効率化するツール。複数構造の並列編集・部分移植・結果比較。Quantum ESPRESSOの.inをターゲット。共有はリンク＋サーバ保存優先だが、当面は単一HTMLで代替。まずは座標・原子種のみ扱う。構造数は任意。ASE/pymatgenでパース・編集し、FastAPIでバックエンド分割。フロントはTanStack Start + shadcn/ui + Mol*。"

## ユーザーシナリオ & テスト（必須）

### User Story 1 - .in を読み込み可視化し編集する (Priority: P1)

計算化学ユーザーが QE の .in を読み込み、3D表示とテーブル編集で構造を修正できる。

**Why this priority**: 解析の出発点であり、他機能の前提になるため。

**Independent Test**: .in を読み込み、3D とテーブルが一致し、座標編集が反映されることを確認できる。

**Acceptance Scenarios**:

1. **Given** 有効な .in ファイル、**When** アップロード/貼り付け、**Then** 原子・格子が 3D/テーブルに表示される
2. **Given** 表示済み構造、**When** テーブルで座標を編集、**Then** 3D表示が即時更新される

---

### User Story 2 - 複数構造を並べて比較・部分移植する (Priority: P2)

ユーザーが構造A/Bを並列表示し、原子の部分的なコピー・移植・シフトを行って比較できる。

**Why this priority**: 実験/計算条件の比較・構造改変の検証に直結するため。

**Independent Test**: A/Bを読み込み、選択原子の移植・整列が可能で比較できる。

**Acceptance Scenarios**:

1. **Given** 構造A/Bが読み込み済み、**When** Aの一部をBへコピー、**Then** Bの3D/テーブルに反映される
2. **Given** A/Bの選択原子、**When** シフト/整列を適用、**Then** 距離や位置関係が更新される

---

### User Story 3 - スーパーセル構築と共有 (Priority: P3)

ユーザーが格子とシーケンスを指定してスーパーセルを生成し、表示状態を共有できる。

**Why this priority**: 研究発表や共同作業での共有・検証に重要。

**Independent Test**: 生成ルールに従ってスーパーセルが作成され、共有リンク/ファイルで再現できる。

**Acceptance Scenarios**:

1. **Given** 格子パラメータと配列シーケンス、**When** 生成、**Then** 期待原子数と表示が得られる
2. **Given** 表示状態、**When** 共有用エクスポート、**Then** 別環境で同一表示が再現できる

---

### Edge Cases

- .in が不完全/無効、格子情報が欠落している場合（当面は座標・原子種のみ）
- 原子数が多い場合（例: >10k）
- 不明な元素記号や部分占有、異常な座標値
- A/Bで原子数が異なる場合の距離・整列操作
- オフライン環境で共有リンクを開く場合（単一HTMLでの代替）

## 要件（必須）

### Functional Requirements

- **FR-001**: システムは Quantum ESPRESSO の .in を読み込み、まずは原子種・座標を抽出できる
- **FR-002**: システムは抽出した構造を 3D (Mol*) とテーブルで同期表示する
- **FR-003**: ユーザーは原子座標・元素種を編集できる
- **FR-004**: ユーザーは複数構造を並列表示し、部分コピー/移植/整列/シフトができる
- **FR-005**: システムは距離計算など比較用の派生情報を提示できる
- **FR-006**: ユーザーは格子パラメータやシーケンスを指定してスーパーセルを生成できる（第2段階）
- **FR-007**: 表示状態を共有するため、リンク＋サーバ保存を優先し、当面は単一HTMLで代替できる
- **FR-008**: 解析・編集の主要処理は FastAPI + ASE/pymatgen で実施できる

### Key Entities

- **Structure**: 原子集合と格子情報を持つ構造データ
- **Atom**: 元素記号・座標・付加フラグを保持
- **Lattice**: 格子定数/ベクトル（QE入力と相互変換）
- **Selection**: 選択した原子集合と操作履歴
- **SupercellRecipe**: シーケンスと拡張倍率
- **ViewState**: 表示パラメータ（色/透明度/背景/カメラ）

## 成功条件（必須）

### Measurable Outcomes

- **SC-001**: 代表的な .in（~1k原子）を読み込み、3D表示まで 3 秒以内
- **SC-002**: テーブル編集が 300ms 以内で 3D に反映される
- **SC-003**: 共有リンク/ファイルで同一表示が再現できる（誤差ゼロ）
- **SC-004**: P1/P2 機能の利用者が主タスクを迷わず完了できる（ユーザーテストで 80%以上）
